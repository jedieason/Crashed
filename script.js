const scriptUrl="https://script.google.com/macros/s/AKfycbxPoiqIEsIRR4rnsrjKzULK3Pm7GevufMIlqQ2rsuORIFBNx7KK_gAWIWELIUL3QolK/exec";let interval,username,balance=0,betAmount=0,multiplier=1,gameRunning=!1,pathData="M0,200",areaData="M0,200",cashedOut=!1,cashoutMultiplier=0;const canvas=document.getElementById("chartCanvas"),canvasWidth=canvas.width,ctx=canvas.getContext("2d"),scale=3;function updateBalance(){username?(balance=Math.round(100*balance)/100,document.getElementById("balance").textContent=balance.toFixed(2)+" NTD",updateServerBalance()):document.getElementById("balance").textContent="請先註冊或登入"}function updateMultiplier(){document.getElementById("multiplier").textContent=multiplier.toFixed(2)+"×"}function updateLine(){canvas.width=canvas.offsetWidth*scale,canvas.height=canvas.offsetHeight*scale,ctx.scale(scale,scale),ctx.clearRect(0,0,canvas.width/scale,canvas.height/scale),ctx.beginPath();const e=ctx.createLinearGradient(0,0,0,canvas.height/scale);e.addColorStop(0,"rgba(255, 167, 38, 0.9)"),e.addColorStop(1,"rgba(255, 167, 38, 0.5)");const t=pathData.split(" ").map(e=>{const[t,n]=e.substring(1).split(",");return{x:parseFloat(t),y:parseFloat(n)}});ctx.moveTo(0,200),t.forEach(e=>{ctx.lineTo(e.x,e.y)}),ctx.lineTo(t[t.length-1].x,200),ctx.closePath(),ctx.fillStyle=e,ctx.fill(),ctx.beginPath(),ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.strokeStyle="#333",ctx.lineWidth=13/scale,ctx.stroke();const n=t[t.length-1];ctx.beginPath(),ctx.arc(n.x,n.y,5/scale,0,2*Math.PI,!1),ctx.fillStyle="#333",ctx.fill()}function placeBet(){gameRunning&&!cashedOut||(interval&&clearInterval(interval),document.getElementById("multiplier").classList.remove("crashed"),betAmount=parseFloat(document.getElementById("betAmount").value),isNaN(betAmount)||0==betAmount?showAlertInfo("請輸入下注金額"):betAmount<0?showAlertInfo("不要鬧"):betAmount>balance?showAlertInfo("餘額不足"):(document.getElementById("multiplier").style.color="#333",balance-=betAmount,gameRunning=!0,cashedOut=!1,startGame(),updateBalance(),updateServerBalance()))}function startGame(){interval&&clearInterval(interval),multiplier=1,pathData="M0,200",areaData="M0,200",updateMultiplier(),updateLine(),interval=setInterval(gameTick,getInterval(multiplier))}function getInterval(e){return e<=50?100-e*e/250*99:1}function gameTick(){if(Math.random()<getProbability(multiplier))clearInterval(interval),document.getElementById("multiplier").classList.add("crashed"),document.getElementById("multiplier").textContent="Crashed at "+multiplier.toFixed(2)+"x",document.getElementById("multiplier").style.color="red",gameRunning=!1,betAmount=0;else{multiplier+=.01,updateMultiplier();const e=Math.log(multiplier)*canvasWidth*.6,t=200-35*(multiplier-1);pathData+=` L${e},${t}`,areaData+=` L${e},${t}`,updateLine(),clearInterval(interval),interval=setInterval(gameTick,getInterval(multiplier))}}function getProbability(e){return((e-.99)/(e+.01)-(e-1)/e)*e*1.05}function cashOut(){gameRunning&&!cashedOut&&(cashoutMultiplier=multiplier,showCashoutInfo(),balance+=betAmount*multiplier,gameRunning=!1,cashedOut=!0,updateBalance(),updateServerBalance(),document.getElementById("multiplier").classList.remove("crashed"),document.getElementById("multiplier").style.color="#333")}function setBetPercentage(e){if(gameRunning&&!cashedOut)return;const t=balance*(e/100);document.getElementById("betAmount").value=t.toFixed(2)}function setBetRemainder(){if(gameRunning&&!cashedOut)return;const e=balance%100;document.getElementById("betAmount").value=e.toFixed(2)}function showCashoutInfo(){const e=document.getElementById("chart"),t=document.createElement("div");t.className="cashout-info",t.textContent=`止盈於 ${cashoutMultiplier.toFixed(2)}x`,e.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{e.removeChild(t)},1e3)},1e3)}function showAlertInfo(e){const t=document.getElementById("chart"),n=document.createElement("div");n.className="alert-info",n.textContent=e,t.appendChild(n),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>{t.removeChild(n)},1e3)},1e3)}function toggleIntro(){const e=document.getElementById("introModal");"none"===e.style.display||""===e.style.display?(e.style.display="block",e.style.animation="fadeInZoom 0.5s forwards"):(e.style.animation="fadeOutZoom 0.5s forwards",setTimeout(()=>{e.style.display="none"},500))}function showMessage(e,t){const n=document.querySelector(".message");n&&document.body.removeChild(n);const a=document.createElement("div");a.className=`message ${t}`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>{document.body.removeChild(a)},1e3)},1e3)}function toggleRegister(){const e=document.getElementById("registerModal"),t=document.getElementById("loginModal");"none"===e.style.display||""===e.style.display?(e.style.display="block",e.style.animation="fadeInZoom 0.5s forwards",t.style.display="none"):(e.style.animation="fadeOutZoom 0.5s forwards",setTimeout(()=>{e.style.display="none"},500))}function toggleLogin(){const e=document.getElementById("loginModal"),t=document.getElementById("registerModal");"none"===e.style.display||""===e.style.display?(e.style.display="block",e.style.animation="fadeInZoom 0.5s forwards",t.style.display="none"):(e.style.animation="fadeOutZoom 0.5s forwards",setTimeout(()=>{e.style.display="none"},500))}function register(){const e=document.getElementById("registerUsername").value,t=document.getElementById("registerPassword").value;fetch(`${scriptUrl}?action=registerUser&username=${e}&password=${t}`).then(e=>e.json()).then(t=>{if(t.success){showMessage("註冊成功！","cashout-info"),username=e;const n=document.getElementById("userButton");n.style.display="block",n.textContent=`${username}`,document.querySelector(".login-button").style.display="none",document.querySelector(".register-button").style.display="none",balance=t.balance,updateBalance(),toggleRegister()}else showMessage(t.message,"alert-info")})}function login(){const e=document.getElementById("loginUsername").value,t=document.getElementById("loginPassword").value;fetch(`${scriptUrl}?action=checkLogin&username=${e}&password=${t}`).then(e=>e.json()).then(t=>{if(t.success){balance=t.balance,username=e;const n=document.getElementById("userButton");n.style.display="block",n.textContent=`${username}`,document.querySelector(".login-button").style.display="none",document.querySelector(".register-button").style.display="none",updateBalance(),showMessage("登入成功！","cashout-info"),toggleLogin()}else showMessage("登入失敗！","alert-info")})}function updateServerBalance(){fetch(`${scriptUrl}?action=updateBalance&username=${username}&balance=${balance}`).then(e=>e.json()).then(e=>{e.success||showMessage("更新餘額失敗","alert-info")})}canvas.width=canvas.offsetWidth*scale,canvas.height=canvas.offsetHeight*scale,ctx.scale(scale,scale),updateMultiplier();
